<h1 id="measure-calculation">Measure Calculation</h1>
<h2 id="features">Features</h2>
<h3 id="metrics">Metrics</h3>
<p>Metrics are calculated by scraping the HTML test result pages which are generated by the back-end Linq queries.
The purpose is to distill the tabular results down to a single figure, and add a traffic light colour.</p>
<p><img src="static/docs/./images/metrics.jpg" alt="metrics">  </p>
<p>In addition, the last 10 metrics are displayed in a sparkline to give a sense of the recent history.</p>
<p><img src="static/docs/./images/sparklines.jpg" alt="sparklines">  </p>
<h3 id="working-set">Working Set</h3>
<p>We are generally interested in the latest working set of data (i.e those of the last few days). To reduce clutter and increase loading speed, the list is initially limited to a configured number of tests. Older results are accessed via a chevron at the bottom of the list.</p>
<p><img src="static/docs/./images/clinics.jpg" alt="current working set"></p>
<h3 id="daily-reruns">Daily Reruns</h3>
<p>Tests are often rerun on the same day once corrections have been made. Clusters are displayed by stepping the list (omitting the name) for the same test on the same day.</p>
<p><img src="static/docs/./images/validations.jpg" alt="stepped list"></p>
<h2 id="data-parsing">Data parsing</h2>
<h3 id="models">Models</h3>
<p>Both the file names and the contents are parsed for data. The file name gives the test type and date/time info. The content gives the metric data.</p>
<p>These are the key data models.</p>
<pre><code class="language-ts">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> IFileInfo {
    name: <span class="hljs-built_in">String</span>;              <span class="hljs-comment">// Full file name</span>
    namePrefix?: <span class="hljs-built_in">String</span>;       <span class="hljs-comment">// File type (match to prefix)</span>
    baseName?: <span class="hljs-built_in">String</span>;         <span class="hljs-comment">// File name preceding date</span>
    sequenceNo?: <span class="hljs-built_in">Number</span>;       <span class="hljs-comment">// Used to group daily re-runs</span>
    displayName?: <span class="hljs-built_in">String</span>;      <span class="hljs-comment">// Truncated name for stepped display</span>
    effectiveDate: <span class="hljs-built_in">Date</span>;       <span class="hljs-comment">// Test date (from filename)</span>
    effectiveTime?: <span class="hljs-built_in">String</span>;    <span class="hljs-comment">// Test time (from filename)</span>
    lastModified?: <span class="hljs-built_in">Date</span>;       <span class="hljs-comment">// File timestamp</span>
    lastRefresh?: <span class="hljs-built_in">String</span>;      <span class="hljs-comment">// Last time file was read from disk </span>
    content?: <span class="hljs-built_in">String</span>;          <span class="hljs-comment">// File contents</span>
    metric?: <span class="hljs-built_in">Number</span> | <span class="hljs-built_in">String</span>;  <span class="hljs-comment">// Calculated metric</span>
    badgeColor?: <span class="hljs-built_in">String</span>;       <span class="hljs-comment">// Colour from metric value</span>
  }</code></pre>
<pre><code class="language-ts">  <span class="hljs-keyword">export</span> interface <span class="hljs-title">IMeasure</span> {
    <span class="hljs-attribute">id:</span><span class="hljs-string"> String</span>;
    <span class="hljs-attribute">title</span>: <span class="hljs-built_in">String</span>;
    metric?: <span class="hljs-built_in">Number</span> | <span class="hljs-built_in">String</span>;
    <span class="hljs-built_in">color</span>?: <span class="hljs-built_in">String</span>;
    icon?: <span class="hljs-built_in">String</span>;
    link?: <span class="hljs-built_in">String</span>;
    history?: <span class="hljs-built_in">Number</span>[];
    narrative?: <span class="hljs-built_in">String</span>;
  }</code></pre>
<h3 id="process-steps">Process steps</h3>
<p>The <code>data.service</code> provides file processing, with the help of the following sub-services,</p>
<ol>
<li><p><strong>File list fetching</strong> (<em>file.service.ts</em>)<br>Invokes http.get to fetch the file list, and handles pending flag and saving of the list to Redux store.</p>
</li>
<li><p><strong>File name parsing</strong> (<em>name-parsing.service.ts</em>)<br>Converts each file name into a FileInfo object, separating out date, time and test type.</p>
</li>
<li><p><strong>File sorting and sequencing</strong> (<em>list-formatter.service.ts</em>)<br>Files are sorted by date, type and time. A sequence number is applied to files of the same date and type, to group repeat runs on the same day.</p>
</li>
<li><p><strong>Content is fetched and metric extracted</strong> (<em>format.service.ts</em> and derived classes)<br>The file itself is read (with FileService) and the metric value is extracted in a sub-class of FormatService.</p>
</li>
</ol>
<h3 id="service-sub-classing">Service sub-classing</h3>
<p>Each page has 90% identical data initialization, except for a few methods. Therefore, the bulk of the code is in an abstract base class <strong>DataService</strong> which has abstract methods for the parts that differ.  </p>
<p>For example, <strong>ValidationsDataService</strong>. Note that FormatService is also subclassed, so we pass the required type in the call to <code>super()</code></p>
<pre><code class="language-ts"><span class="hljs-meta">@Injectable</span>()
export <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataService</span> {</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-string">config$:</span> Observable&lt;any&gt;;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-string">files$:</span> Observable&lt;IFileInfo[]&gt;;

  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-string">PAGE:</span> string;
  ...
  constructor (
    <span class="hljs-keyword">protected</span> <span class="hljs-string">formatService:</span> FormatService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">nameParsingService:</span> NameParsingService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">listFormatterService:</span> ListFormatterService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">fileService:</span> FileService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">logger:</span> Logger,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">pageActions:</span> PageActions,
  ) {}

  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> getLatestMeasureFromFiles(<span class="hljs-string">files:</span> IFileInfo[]): IMeasureUpdate;
  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> calcHistory(<span class="hljs-string">files:</span> IFileInfo[]): number[];
}</code></pre>
<pre><code class="language-ts{10}"><span class="hljs-meta">@Injectable</span>()
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidationsDataService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DataService</span> {</span>

  <span class="hljs-meta">@select</span>([<span class="hljs-string">'config'</span>, <span class="hljs-string">'validationsConfig'</span>]) <span class="hljs-string">config$:</span> Observable&lt;any&gt;;
  <span class="hljs-meta">@select</span>([<span class="hljs-string">'pages'</span>, <span class="hljs-string">'validations'</span>, <span class="hljs-string">'files'</span>]) <span class="hljs-string">files$:</span> Observable&lt;IFileInfo[]&gt;;

  <span class="hljs-keyword">protected</span> PAGE = <span class="hljs-string">'validations'</span>;
  ...
  constructor (
    <span class="hljs-keyword">protected</span> <span class="hljs-string">formatService:</span> ValidationsFormatService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">nameParsingService:</span> NameParsingService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">listFormatterService:</span> ListFormatterService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">fileService:</span> FileService,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">logger:</span> Logger,
    <span class="hljs-keyword">protected</span> <span class="hljs-string">store:</span> StoreService
  ) {
    <span class="hljs-keyword">super</span>(formatService, nameParsingService, listFormatterService, fileService, 
          logger, store.actions.validationsActions);
  }

  <span class="hljs-keyword">protected</span> getLatestMeasureFromFiles(<span class="hljs-string">files:</span> IFileInfo[]): IMeasureUpdate {
    ...
  }

  <span class="hljs-keyword">protected</span> calcHistory(files): number[] {
    ...
}</code></pre>
